# Guia: Construindo a Tela de Fornecedores com Persist√™ncia üì±

Um guia completo para construir a tela `HomePage` com funcionalidades de CRUD e persist√™ncia de dados usando SharedPreferences.

---

## üìã Vis√£o Geral do Projeto

**Objetivo:** Criar uma tela que permite:
- ‚úÖ Visualizar lista de fornecedores com imagem
- ‚úÖ Adicionar novos fornecedores
- ‚úÖ Editar fornecedores existentes
- ‚úÖ Remover fornecedores (swipe to dismiss)
- ‚úÖ Ver detalhes de cada fornecedor
- ‚úÖ Persistir dados no banco local (SharedPreferences)
- ‚úÖ Atualizar lista (pull to refresh)
- ‚úÖ Orienta√ß√£o visual para o usu√°rio (tutorial)

---

## üéØ Etapas de Implementa√ß√£o

### **ETAPA 1: Setup Inicial e Estrutura de Dados**

#### Objetivo
Criar a estrutura b√°sica do widget com o DAO e estrutura de dados.

#### Passos

1. **Crie o DTO (Data Transfer Object)**
   - Arquivo: `lib/features/providers/infrastructure/dtos/provider_dto.dart`
   - Deve conter: `id`, `name`, `image_url`, `rating`, `distance_km`, `updated_at`, `metadata`, `brand_color_hex`
   - Implemente `toMap()` e `fromMap()` para serializa√ß√£o

2. **Implemente o DAO (Data Access Object)**
   - Arquivo: `lib/features/providers/infrastructure/local/providers_local_dao.dart`
   - Interface com m√©todos: `upsertAll()`, `listAll()`, `getById()`, `clear()`
   - Arquivo: `lib/features/providers/infrastructure/local/providers_local_dao_shared_prefs.dart`
   - Implementa√ß√£o usando SharedPreferences

3. **Crie a HomePage b√°sica**
   ```dart
   class HomePage extends StatefulWidget {
     static const routeName = '/home';
     
     @override
     State<HomePage> createState() => _HomePageState();
   }

   class _HomePageState extends State<HomePage> {
     List<ProviderDto> _providers = [];
     bool _loadingProviders = true;
     
     @override
     void initState() {
       super.initState();
       _loadProviders();
     }
     
     @override
     Widget build(BuildContext context) {
       return Scaffold(
         appBar: AppBar(title: const Text('CeliLac Life')),
         body: _buildBody(),
       );
     }
   }
   ```

---

### **ETAPA 2: Carregar e Exibir Fornecedores em Lista**

#### Objetivo
Implementar o carregamento de dados e exibir em um ListView.

#### Passos

1. **Implemente `_loadProviders()`**
   - Carregue dados do DAO
   - Se vazio, crie dados de teste
   - Atualize o estado com `setState()`

   ```dart
   Future<void> _loadProviders() async {
     setState(() => _loadingProviders = true);
     try {
       final dao = ProvidersLocalDaoSharedPrefs();
       var list = await dao.listAll();
       
       if (list.isEmpty) {
         // Crie dados de teste
         list = await _createTestData();
         await dao.upsertAll(list);
       }
       
       setState(() {
         _providers = list;
         _loadingProviders = false;
       });
     } catch (e) {
       setState(() {
         _providers = [];
         _loadingProviders = false;
       });
     }
   }
   ```

2. **Crie ListView para exibir fornecedores**
   - Use `ListView.builder` com √≠ndice
   - Cada item √© um `ListTile` ou `Row` personalizado
   - Exiba imagem, nome e nota

   ```dart
   ListView.builder(
     itemCount: _providers.length,
     itemBuilder: (context, idx) {
       final p = _providers[idx];
       return ListTile(
         leading: p.image_url != null
             ? Image.network(p.image_url!, width: 80, height: 80)
             : Icon(Icons.store),
         title: Text(p.name),
         subtitle: Text('Nota: ${p.rating.toStringAsFixed(1)}'),
       );
     },
   )
   ```

3. **Implemente RefreshIndicator (pull to refresh)**
   - Envolva a ListView em `RefreshIndicator`
   - `onRefresh` chama `_loadProviders()`

   ```dart
   RefreshIndicator(
     onRefresh: _loadProviders,
     child: ListView.builder(...)
   )
   ```

---

### **ETAPA 3: Adicionar Efeito Zebrado e Melhorar Visual**

#### Objetivo
Melhorar a experi√™ncia visual com altern√¢ncia de cores e altura din√¢mica.

#### Passos

1. **Adicione altern√¢ncia de cores**
   - Calcule `isEven = idx % 2 == 0`
   - Use cores diferentes: `Colors.blue[50]` e `Colors.grey[100]`
   - Envolva cada item em `Container(color: backgroundColor)`

2. **Aumente altura dos itens**
   - Use `visualDensity: VisualDensity(vertical: 2)` ou crie Row customizado
   - Imagem com altura fixa (90-110px)
   - Layout: Imagem | Nome/Nota | Dist√¢ncia/Bot√µes

3. **Adicione espa√ßamento entre itens**
   - `Padding(padding: EdgeInsets.only(bottom: 2))`

4. **Melhore o layout com Row customizado**
   - Substitua ListTile por Row para mais controle
   - Imagem em ClipRRect com BorderRadius
   - Conte√∫do centralizado verticalmente

---

### **ETAPA 4: Implementar Clique para Ver Detalhes**

#### Objetivo
Abrir um modal com informa√ß√µes completas do fornecedor.

#### Passos

1. **Crie `_showProviderDetails()`**
   ```dart
   void _showProviderDetails(ProviderDto provider, int index) {
     showDialog(
       context: context,
       builder: (context) => AlertDialog(
         title: Text(provider.name),
         content: SingleChildScrollView(
           child: Column(
             mainAxisSize: MainAxisSize.min,
             children: [
               if (provider.image_url != null)
                 Image.network(provider.image_url!, height: 120, width: 280),
               Text('Nota: ${provider.rating}'),
               if (provider.distance_km != null)
                 Text('Dist√¢ncia: ${provider.distance_km} km'),
               Text('Atualizado: ${provider.updated_at}'),
             ],
           ),
         ),
         actions: [
           TextButton(onPressed: () => Navigator.pop(context), child: Text('Fechar')),
         ],
       ),
     );
   }
   ```

2. **Adicione GestureDetector**
   - Envolva cada item em `GestureDetector`
   - `onTap: () => _showProviderDetails(p, idx)`

3. **Melhore o tratamento de imagem no modal**
   - Adicione `errorBuilder` para imagens que falham
   - Adicione `loadingBuilder` com `CircularProgressIndicator`
   - Envolva em `ClipRRect` com BorderRadius

---

### **ETAPA 5: Adicionar Novo Fornecedor (Create)**

#### Objetivo
Permitir que o usu√°rio crie novo fornecedor via formul√°rio.

#### Passos

1. **Crie `_showProviderForm()`**
   ```dart
   void _showProviderForm({ProviderDto? provider, int? index}) async {
     final result = await showDialog<ProviderDto>(
       context: context,
       builder: (context) {
         final nameController = TextEditingController(text: provider?.name ?? '');
         final ratingController = TextEditingController(text: provider?.rating.toString() ?? '5.0');
         
         return AlertDialog(
           title: Text(provider == null ? 'Novo Fornecedor' : 'Editar Fornecedor'),
           content: SingleChildScrollView(
             child: Column(
               mainAxisSize: MainAxisSize.min,
               children: [
                 TextField(controller: nameController, decoration: InputDecoration(labelText: 'Nome')),
                 TextField(controller: ratingController, decoration: InputDecoration(labelText: 'Nota (0-5)')),
               ],
             ),
           ),
           actions: [
             TextButton(onPressed: () => Navigator.pop(context), child: Text('Cancelar')),
             ElevatedButton(onPressed: () {
               final dto = ProviderDto(
                 id: provider?.id ?? DateTime.now().millisecondsSinceEpoch,
                 name: nameController.text,
                 rating: double.tryParse(ratingController.text) ?? 5.0,
                 // ... outros campos
               );
               Navigator.pop(context, dto);
             }, child: Text('Salvar')),
           ],
         );
       },
     );
     
     if (result != null) {
       final dao = ProvidersLocalDaoSharedPrefs();
       List<ProviderDto> newList = List.from(_providers);
       if (index != null) {
         newList[index] = result;
       } else {
         newList.add(result);
       }
       await dao.clear();
       await dao.upsertAll(newList);
       await _loadProviders();
     }
   }
   ```

2. **Adicione FloatingActionButton**
   ```dart
   floatingActionButton: FloatingActionButton(
     onPressed: () => _showProviderForm(),
     child: Icon(Icons.add),
   )
   ```

---

### **ETAPA 6: Editar Fornecedor (Update)**

#### Objetivo
Permitir que o usu√°rio edite um fornecedor existente.

#### Passos

1. **Reutilize `_showProviderForm()`**
   - Passe `provider` e `index` como par√¢metro
   - Se `index != null`, √© edi√ß√£o; sen√£o, √© cria√ß√£o

2. **Adicione bot√£o Editar no modal de detalhes**
   ```dart
   TextButton(
     onPressed: () {
       Navigator.pop(context);
       _showProviderForm(provider: provider, index: index);
     },
     child: Text('Editar'),
   )
   ```

3. **Implemente salvar edi√ß√µes**
   - Remova do banco com `clear()`
   - Insira lista atualizada com `upsertAll()`
   - Recarregue com `_loadProviders()`

---

### **ETAPA 7: Remover Fornecedor (Delete) com Swipe**

#### Objetivo
Implementar swipe to dismiss (UX padr√£o mobile) para remover.

#### Passos

1. **Implemente `_removeProvider()`**
   ```dart
   Future<void> _removeProvider(int index) async {
     final dao = ProvidersLocalDaoSharedPrefs();
     List<ProviderDto> newList = List.from(_providers);
     newList.removeAt(index);
     await dao.clear();
     await dao.upsertAll(newList);
     setState(() => _providers = newList);
   }
   ```

2. **Envolva items em `Dismissible`**
   ```dart
   Dismissible(
     key: Key(p.id.toString()),
     background: Container(
       color: Colors.red,
       alignment: Alignment.centerRight,
       child: Icon(Icons.delete, color: Colors.white),
     ),
     direction: DismissDirection.endToStart,
     confirmDismiss: (direction) async {
       return await showDialog<bool>(
         context: context,
         builder: (context) => AlertDialog(
           title: Text('Remover ${p.name}?'),
           actions: [
             TextButton(onPressed: () => Navigator.pop(context, false), child: Text('Cancelar')),
             ElevatedButton(onPressed: () => Navigator.pop(context, true), child: Text('Remover')),
           ],
         ),
       ) ?? false;
     },
     onDismissed: (direction) async {
       await _removeProvider(_providers.indexOf(p));
     },
     child: // seu item aqui
   )
   ```

3. **Adicione bot√£o Remover no modal (alternativo)**
   - Opcional: tamb√©m ofere√ßa remo√ß√£o pelo bot√£o

---

### **ETAPA 8: Tutorial/Orienta√ß√£o para o Usu√°rio**

#### Objetivo
Mostrar um modal com instru√ß√µes de como usar a tela.

#### Passos

1. **Crie vari√°vel de estado**
   ```dart
   bool _showProvidersTutorial = true;
   ```

2. **Crie `_buildTutorialItem()` helper**
   ```dart
   Widget _buildTutorialItem({
     required IconData icon,
     required String title,
     required String description,
   }) {
     return Row(
       crossAxisAlignment: CrossAxisAlignment.start,
       children: [
         Icon(icon, color: Colors.blue),
         SizedBox(width: 12),
         Expanded(child: Column(
           crossAxisAlignment: CrossAxisAlignment.start,
           children: [
             Text(title, style: TextStyle(fontWeight: FontWeight.bold)),
             Text(description),
           ],
         )),
       ],
     );
   }
   ```

3. **Crie modal de orienta√ß√£o com Stack.Positioned**
   ```dart
   if (_showProvidersTutorial)
     Positioned.fill(
       child: Container(
         color: Colors.black26,
         child: Center(
           child: Card(
             child: Padding(
               padding: EdgeInsets.all(24),
               child: Column(
                 mainAxisSize: MainAxisSize.min,
                 children: [
                   Text('Como gerenciar fornecedores', style: Theme.of(context).textTheme.headlineSmall),
                   SizedBox(height: 16),
                   _buildTutorialItem(icon: Icons.edit, title: 'Editar fornecedor', description: 'Toque no √≠cone de l√°pis'),
                   _buildTutorialItem(icon: Icons.touch_app, title: 'Ver detalhes', description: 'Toque na linha'),
                   _buildTutorialItem(icon: Icons.add_circle, title: 'Adicionar fornecedor', description: 'Toque no bot√£o +'),
                   _buildTutorialItem(icon: Icons.swipe_left, title: 'Remover fornecedor', description: 'Deslize para esquerda'),
                   SizedBox(height: 24),
                   ElevatedButton(onPressed: () => setState(() => _showProvidersTutorial = false), child: Text('Fechar')),
                 ],
               ),
             ),
           ),
         ),
       ),
     ),
   ```

4. **Exiba o tutorial sempre ou na primeira vez**
   - Op√ß√£o 1: Sempre exibir (mais did√°tico)
   - Op√ß√£o 2: Salvar prefer√™ncia e exibir s√≥ primeira vez

---

### **ETAPA 9: Ajustes Finais de Layout**

#### Objetivo
Polir a interface com espa√ßamento e dimens√µes corretas.

#### Passos

1. **Reduzir padding vertical do ListView**
   - De `16` para `0` para subir primeiro item perto da AppBar

2. **Adicionar espa√ßamento entre linhas**
   - `Padding(padding: EdgeInsets.only(bottom: 2))`

3. **Aumentar altura de items**
   - Imagem: `height: 90`, `width: 80`

4. **Melhorar BorderRadius**
   - Apenas canto superior esquerdo arredondado
   - `BorderRadius.only(topLeft: Radius.circular(16), bottomLeft: Radius.circular(16))`

---

### **ETAPA 10: Corrigir Problemas de Persist√™ncia**

#### Objetivo
Garantir que dados removidos n√£o reapare√ßam ao reiniciar.

#### Passos

1. **Problema**: `_loadProviders()` recria dados de teste toda vez
   - **Solu√ß√£o**: Carregar primeiro, s√≥ criar se vazio

   ```dart
   Future<void> _loadProviders() async {
     try {
       final dao = ProvidersLocalDaoSharedPrefs();
       var list = await dao.listAll(); // Carregue primeiro!
       
       if (list.isEmpty) {
         // S√≥ crie dados de teste se n√£o houver nada
         list = await _createTestData();
         await dao.upsertAll(list);
       }
       
       setState(() => _providers = list);
     } catch (e) {
       // ...
     }
   }
   ```

2. **Problema**: `upsertAll()` mescla dados em vez de substituir
   - **Solu√ß√£o**: Sempre fazer `clear()` antes de `upsertAll()`

   ```dart
   await dao.clear();
   await dao.upsertAll(newList);
   ```

---

## üé® Paleta de Cores Recomendada

- **Fundo zebrado (par)**: `Colors.blue[50]` (#E3F2FD)
- **Fundo zebrado (√≠mpar)**: `Colors.grey[100]` (#F5F5F5)
- **Prim√°ria**: `Colors.blue` ou tema do app
- **Remover**: `Colors.red`
- **√çcones desabilitados**: `Colors.grey[400]`

---

## üì¶ Estrutura de Arquivos Final

```
lib/
‚îú‚îÄ‚îÄ features/
‚îÇ   ‚îî‚îÄ‚îÄ providers/
‚îÇ       ‚îú‚îÄ‚îÄ infrastructure/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dtos/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ provider_dto.dart
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ local/
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ providers_local_dao.dart
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ providers_local_dao_shared_prefs.dart
‚îÇ       ‚îî‚îÄ‚îÄ presentation/
‚îÇ           ‚îî‚îÄ‚îÄ pages/
‚îÇ               ‚îî‚îÄ‚îÄ home_page.dart
‚îî‚îÄ‚îÄ main.dart
```

---

## üîó Arquivos Relacionados

- `lib/services/shared_preferences_services.dart` - Servi√ßo de prefer√™ncias
- `lib/services/preferences_keys.dart` - Chaves de prefer√™ncias
- `pubspec.yaml` - Depend√™ncias (shared_preferences)

---

## üí° Dicas para Ensinar aos Alunos

1. **Comece simples**: Etapas 1-3 (estrutura e exibi√ß√£o)
2. **Incremente funcionalidade**: Etapas 4-7 (CRUD)
3. **Polir interface**: Etapa 9 (layout)
4. **Debug**: Etapa 10 (persist√™ncia)
5. **Oriente visualmente**: Etapa 8 (tutorial)

---

## üìö Conceitos-Chave Ensinados

- ‚úÖ Gerenciamento de Estado (setState)
- ‚úÖ Padr√£o DAO (Data Access Object)
- ‚úÖ Serializa√ß√£o/Desserializa√ß√£o JSON
- ‚úÖ CRUD Operations (Create, Read, Update, Delete)
- ‚úÖ Persist√™ncia Local (SharedPreferences)
- ‚úÖ Widgets: ListView, AlertDialog, Dismissible, etc
- ‚úÖ UX Padr√£o Mobile (swipe to dismiss, pull to refresh)
- ‚úÖ Tratamento de Erros
- ‚úÖ Anima√ß√µes b√°sicas
- ‚úÖ Modais e Di√°logos

---

**√öltima atualiza√ß√£o**: 28 de outubro de 2025
